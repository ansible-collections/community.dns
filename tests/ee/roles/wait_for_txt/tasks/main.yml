---
# Copyright (c) Ansible Project
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later

- name: Wait for existing TXT entry
  community.dns.wait_for_txt:
    records:
      - name: github.com
        values: |
          {{ query('community.dns.lookup_as_dict', 'github.com', type='TXT') | map(attribute='value') | list }}
      - name: github.io
        values: []
    query_timeout: 20
    timeout: 60
  register: success

- name: Validate results
  assert:
    that:
      - success is not changed
      - success.msg == 'All checks passed'
      - success.completed == 2
      - success.records | length == 2
      - success.records[0].name == 'github.com'
      - success.records[0].done == true
      - "'values' in success.records[0]"
      - success.records[0].check_count == 1
      - success.records[1].name == 'github.io'
      - success.records[1].done == true
      - "'values' in success.records[1]"
      - success.records[1].check_count == 1

- name: Wait for non-existing TXT entry
  community.dns.wait_for_txt:
    records:
      - name: does_not_exist.ansible.com
        values: test
    timeout: 0
  register: timeout
  failed_when: timeout is not failed

- name: Validate results
  assert:
    that:
      - timeout.msg == 'Timeout (0 out of 1 check(s) passed).'
      - timeout.completed == 0
      - timeout.records | length == 1
      - timeout.records[0].name == 'does_not_exist.ansible.com'
      - timeout.records[0].done == false
      - "'values' in timeout.records[0]"
      - timeout.records[0].check_count == 1

- name: Wait for non-existing TXT value
  community.dns.wait_for_txt:
    records:
      - name: github.com
        # random digits generated by https://www.random.org/
        values: x9717627475397185312575692320809591701005198751588993668249007340758823426405452359342719842260291210
    timeout: 0
  register: timeout
  failed_when: timeout is not failed

- name: Validate results
  assert:
    that:
      - timeout.msg == 'Timeout (0 out of 1 check(s) passed).'
      - timeout.completed == 0
      - timeout.records | length == 1
      - timeout.records[0].name == 'github.com'
      - timeout.records[0].done == false
      - "'values' in timeout.records[0]"
      - timeout.records[0].check_count == 1
