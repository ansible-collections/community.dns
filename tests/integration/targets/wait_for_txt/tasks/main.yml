---
- name: Wait for existing TXT entry
  wait_for_txt:
    records:
      - name: github.com
        values: |
          {{ query('community.general.dig', 'github.com', 'qtype=TXT') | map('regex_replace', '" "', '') | list }}
      - name: github.io
        values: []
    timeout: 0
  register: success

- name: Validate results
  assert:
    that:
      - success is not changed
      - success.msg == 'All checks passed'
      - success.completed == 2
      - success.records | length == 2
      - success.records[0].name == 'github.com'
      - success.records[0].done == true
      - "'values' in success.records[0]"
      - success.records[0].check_count == 1
      - success.records[1].name == 'github.io'
      - success.records[1].done == true
      - "'values' in success.records[1]"
      - success.records[1].check_count == 1

- name: Wait for non-existing TXT entry
  wait_for_txt:
    records:
      - name: github.com
        # random digits generated by https://www.random.org/
        values: x9717627475397185312575692320809591701005198751588993668249007340758823426405452359342719842260291210
    timeout: 0
  ignore_errors: true
  register: timeout

- name: Validate results
  assert:
    that:
      - timeout is failed
      - timeout.msg == 'Timeout (0 out of 1 check(s) passed).'
      - timeout.completed == 0
      - timeout.records | length == 1
      - timeout.records[0].name == 'github.com'
      - timeout.records[0].done == false
      - "'values' in timeout.records[0]"
      - timeout.records[0].check_count == 1
